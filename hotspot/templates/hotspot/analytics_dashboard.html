{% extends 'hotspot/base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - 9Com Hotspot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold">Analytics Dashboard</h4>
        <div>
            <form class="d-flex align-items-center" method="get">
                <label class="me-2 text-muted small fw-bold">Time Range:</label>
                <select name="days" class="form-select form-select-sm" style="width: 150px;" onchange="this.form.submit()">
                    <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 Days</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 Days</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>Last 3 Months</option>
                </select>
            </form>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Daily Users Chart -->
    <div class="col-lg-8">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-primary"><i class="fas fa-users me-2"></i>Daily Active Users</h6>
            </div>
            <div class="card-body">
                <div style="height: 250px; position: relative;">
                    <canvas id="userChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hourly Traffic Pattern -->
    <div class="col-lg-4">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-success"><i class="fas fa-clock me-2"></i>Hourly Peak Times</h6>
            </div>
            <div class="card-body">
                <div style="height: 250px; position: relative;">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Bandwidth Trend -->
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-info"><i class="fas fa-network-wired me-2"></i>Total Bandwidth Usage (GB)</h6>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="bandwidthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Users -->
    <div class="col-lg-12">
         <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-warning"><i class="fas fa-trophy me-2"></i>Top High Usage Users</h6>
            </div>
             <div class="card-body">
                 <div style="height: 300px;">
                    <canvas id="topUsersChart"></canvas>
                 </div>
             </div>
         </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Colors
    // const primaryColor = '#2563eb';
    // const primaryLight = 'rgba(37, 99, 235, 0.1)';
    const primaryColor = '#4f46e5'; 
    const primaryLight = 'rgba(79, 70, 229, 0.1)';

    const successColor = '#10b981';
    const infoColor = '#0ea5e9';
    const warningColor = '#f59e0b';
    
    // Data from Django
    const dates = JSON.parse('{{ dates|escapejs }}');
    const userCounts = JSON.parse('{{ user_counts|escapejs }}');
    const bandwidthData = JSON.parse('{{ bandwidth_data|escapejs }}');
    const hours = JSON.parse('{{ hours|escapejs }}');
    const hourlyCounts = JSON.parse('{{ hourly_counts|escapejs }}');
    const topUserNames = JSON.parse('{{ top_user_names|escapejs }}');
    const topUserUsage = JSON.parse('{{ top_user_usage|escapejs }}');

    // Common Options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { 
                display: false 
            },
            tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                titleColor: '#1e293b',
                bodyColor: '#475569',
                borderColor: '#e2e8f0',
                borderWidth: 1,
                padding: 10,
                cornerRadius: 8,
                titleFont: { weight: 'bold' }
            }
        },
        scales: {
            y: { 
                beginAtZero: true, 
                grid: { 
                    borderDash: [5, 5],
                    color: '#f1f5f9'
                },
                ticks: {
                    font: { size: 11 }
                }
            },
            x: { 
                grid: { display: false },
                ticks: {
                     font: { size: 11 }
                }
            }
        }
    };

    // User Chart
    new Chart(document.getElementById('userChart'), {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Unique Users',
                data: userCounts,
                borderColor: primaryColor,
                backgroundColor: primaryLight,
                tension: 0.4,
                fill: true,
                pointRadius: 3,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: primaryColor,
                pointBorderWidth: 2,
                pointHoverRadius: 6
            }]
        },
        options: commonOptions
    });

    // Hourly Chart
    new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: hours.map(h => h.toString().padStart(2, '0') + ":00"),
            datasets: [{
                label: 'Connections',
                data: hourlyCounts,
                backgroundColor: successColor,
                borderRadius: 4,
                hoverBackgroundColor: '#059669'
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: { display: false },
                x: { 
                    grid: { display: false },
                    ticks: { maxTicksLimit: 8, font: { size: 10 } }
                }
            }
        }
    });

    // Bandwidth Chart
    new Chart(document.getElementById('bandwidthChart'), {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                label: 'Total Traffic (GB)',
                data: bandwidthData,
                backgroundColor: infoColor,
                borderRadius: 4,
                hoverBackgroundColor: '#0284c7'
            }]
        },
        options: commonOptions
    });
    
     // Top Users Chart
    new Chart(document.getElementById('topUsersChart'), {
        type: 'bar',
        data: {
            labels: topUserNames,
            datasets: [{
                label: 'Usage (GB)',
                data: topUserUsage,
                backgroundColor: warningColor,
                borderRadius: 4,
                hoverBackgroundColor: '#d97706'
            }]
        },
        options: {
            ...commonOptions,
            indexAxis: 'y',
            scales: {
                x: { 
                    beginAtZero: true,
                    grid: { borderDash: [5, 5], color: '#f1f5f9' }
                },
                y: {
                     grid: { display: false }
                }
            }
        }
    });
</script>
{% endblock %}
