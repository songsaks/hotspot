{% extends 'hotspot/base.html' %}

{% block title %}Hotspot Users - Hotspot Cloud{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .table thead th {
        background: #f8fafc;
        color: #94a3b8;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 700;
        border-bottom: 1px solid #f1f5f9;
        padding: 0.75rem 1rem;
        white-space: nowrap;
    }

    .table tbody td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
        font-size: 0.8rem;
    }

    .table tbody tr:hover {
        background-color: #f8fafc;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        background: #eff6ff;
        color: #3b82f6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 0.8rem;
        flex-shrink: 0;
    }

    .btn-action {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
        text-decoration: none;
        border: 1px solid transparent;
        font-size: 0.75rem;
    }
    
    .btn-del { background: #fff1f2; color: #f43f5e; border-color: #ffe4e6; }
    .btn-del:hover { background: #f43f5e; color: white; }

    .btn-reset { background: #f0fdf4; color: #16a34a; border-color: #dcfce7; }
    .btn-reset:hover { background: #16a34a; color: white; }

    .btn-toggle-on { background: #ecfeff; color: #0891b2; border-color: #cffafe; }
    .btn-toggle-on:hover { background: #0891b2; color: white; }

    .btn-toggle-off { background: #f8fafc; color: #64748b; border-color: #e2e8f0; }
    .btn-toggle-off:hover { background: #64748b; color: white; }

    .profile-select {
        font-size: 0.7rem !important;
        padding: 0.2rem 0.5rem !important;
        min-width: 120px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        background: #ffffff;
    }

    code {
        background: #f1f5f9;
        color: #475569;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', Courier, monospace;
    }

    .status-badge {
        font-size: 0.6rem;
        padding: 0.1rem 0.4rem;
        border-radius: 10px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .status-enabled { background: #dcfce7; color: #15803d; }
    .status-disabled { background: #fee2e2; color: #b91c1c; }

    /* Autocomplete Styles */
    .search-wrapper { position: relative; width: 250px; }
    .autocomplete-items {
        position: absolute; border: 1px solid #e2e8f0; border-bottom: none; border-top: none;
        z-index: 99; top: 100%; left: 0; right: 0; border-radius: 0 0 12px 12px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; background: white;
    }
    .autocomplete-items div { padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
    .autocomplete-items div:hover { background-color: #f8fafc; color: #3b82f6; }
    .autocomplete-active { background-color: #3b82f6 !important; color: #ffffff !important; }

    /* ═══ RESPONSIVE ═══ */
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
        }
        .page-header > div:last-child {
            flex-wrap: wrap;
        }
        .search-wrapper {
            width: 100%;
            order: -1;
        }
        .profile-select {
            min-width: 90px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h4 class="fw-800 mb-0">Hotspot Users</h4>
        <p class="text-muted text-small mb-0">Manage individual user accounts, profiles, and access status</p>
    </div>
    <div class="d-flex gap-2">
        <form action="" method="GET" class="search-wrapper autocomplete" id="searchForm">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                <input id="searchInput" type="text" name="search" class="form-control border-start-0 ps-0" placeholder="Search username..." value="{{ search_query }}" autocomplete="off">
                {% if search_query %}
                    <a href="{% url 'user_list' %}" class="btn btn-outline-secondary border-start-0 border"><i class="fas fa-times"></i></a>
                {% endif %}
            </div>
        </form>
        <a href="{% url 'active_sessions' %}" class="btn btn-primary btn-sm d-flex align-items-center" style="background: #10b981; border:none;">
            <i class="fas fa-satellite-dish me-2"></i> Live Monitor
        </a>
        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#bulkDeleteModal">
            <i class="fas fa-trash-alt me-1"></i> Bulk Delete
        </button>
        <a href="{% url 'user_create' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-1"></i> Add User
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th class="ps-4" style="width: 40px;">
                        <input type="checkbox" class="form-check-input" id="selectAll">
                    </th>
                    <th>User Details</th>
                    <th>Password</th>
                    <th>Active Profile</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr {% if user.is_disabled %}style="background-color: #fffafb;"{% endif %}>
                    <td class="ps-4 text-center">
                        <input type="checkbox" class="form-check-input user-checkbox" name="selected_users" value="{{ user.username }}">
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar {% if user.is_disabled %}bg-light text-muted{% endif %}">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="d-flex flex-column">
                                <span class="fw-800 {% if user.is_disabled %}text-muted text-decoration-line-through{% endif %}">{{ user.username }}</span>
                                {% if user.is_self_reg %}
                                    <span class="text-primary" style="font-size: 0.65rem; font-weight: 600;">
                                         Self-Reg
                                    </span>
                                {% endif %}
                                {% if request.user.is_superuser %}
                                    <span class="text-info" style="font-size: 0.65rem; font-weight: 600;">
                                        <i class="fas fa-network-wired me-1"></i>
                                        {% if user.assigned_routers %}{{ user.assigned_routers }}{% else %}Global{% endif %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td><code>{{ user.password }}</code></td>
                    <td>
                        <form action="{% url 'assign_user_group' %}" method="POST" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="username" value="{{ user.username }}">
                            <select name="groupname" class="form-select profile-select" onchange="this.form.submit()" {% if user.is_disabled %}disabled{% endif %}>
                                <option value="" {% if not user.groupname %}selected{% endif %}>No Profile</option>
                                {% for prof in profiles %}
                                    <option value="{{ prof.groupname }}" {% if user.groupname == prof.groupname %}selected{% endif %}>
                                        {{ prof.groupname }}
                                    </option>
                                {% endfor %}
                            </select>
                        </form>
                    </td>
                    <td class="text-center">
                        {% if user.is_disabled %}
                            <span class="status-badge status-disabled">Disabled</span>
                        {% else %}
                            <span class="status-badge status-enabled">Active</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            <a href="{% url 'toggle_user_status' user.username %}" class="btn-action {% if user.is_disabled %}btn-toggle-on{% else %}btn-toggle-off{% endif %}" title="{% if user.is_disabled %}Enable User{% else %}Disable User{% endif %}">
                                <i class="fas {% if user.is_disabled %}fa-toggle-off{% else %}fa-toggle-on{% endif %}"></i>
                            </a>
                            <button type="button" class="btn-action btn-reset" title="Reset Password" data-bs-toggle="modal" data-bs-target="#resetModal{{ forloop.index }}">
                                <i class="fas fa-key"></i>
                            </button>
                            <a href="{% url 'delete_user' user.username %}" class="btn-action btn-del" title="Delete User" onclick="return confirm('Delete user account permanently?')">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </div>

                        <!-- Reset Password Modal -->
                        <div class="modal fade" id="resetModal{{ forloop.index }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-sm">
                                <div class="modal-content border-0 shadow-lg">
                                    <div class="modal-header border-0 pb-0">
                                        <h6 class="modal-title fw-800">Reset Password</h6>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form action="{% url 'reset_password' user.username %}" method="POST">
                                        {% csrf_token %}
                                        <div class="modal-body py-3">
                                            <div class="text-start mb-2">
                                                <small class="text-muted">User: <strong>{{ user.username }}</strong></small>
                                            </div>
                                            <input type="text" name="new_password" class="form-control form-control-sm" placeholder="Enter new password" value="{{ user.password }}" required>
                                        </div>
                                        <div class="modal-footer border-0 pt-0 justify-content-center">
                                            <button type="submit" class="btn btn-primary btn-sm px-4">Save Changes</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-2x mb-3 opacity-25 d-block"></i>
                        No users found in database.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="card-footer bg-white border-top py-3 d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="text-muted small">
            Showing page <strong class="text-primary">{{ page_obj.number }}</strong> of <strong>{{ page_obj.paginator.num_pages }}</strong>
            <span class="ms-2 badge bg-light text-secondary border">Total {{ page_obj.paginator.count }} users</span>
        </div>
        
        <div class="d-flex align-items-center flex-wrap gap-2">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm mb-0 shadow-sm" style="border-radius: 8px; overflow: hidden;">
                    <!-- First Button -->
                    {% if page_obj.number > 1 %}
                        <li class="page-item">
                            <a class="page-link text-primary fw-bold px-2 px-md-3" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" title="First Page">&laquo; First</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link text-muted px-2 px-md-3">&laquo; First</span>
                        </li>
                    {% endif %}
                    
                    <!-- Previous Button -->
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link text-primary fw-bold px-2" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" title="Previous Page">&lsaquo; Prev</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link text-muted px-2">&lsaquo; Prev</span>
                        </li>
                    {% endif %}
                    
                    <!-- Page Numbers -->
                    {% for i in page_obj.paginator.page_range %}
                        {% if page_obj.number == i %}
                            <li class="page-item active" aria-current="page"><span class="page-link fw-bold px-3">{{ i }}</span></li>
                        {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                            <li class="page-item d-none d-sm-block"><a class="page-link px-3 text-secondary" href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Next Button -->
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link text-primary fw-bold px-2" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" title="Next Page">Next &rsaquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link text-muted px-2">Next &rsaquo;</span>
                        </li>
                    {% endif %}
                    
                    <!-- Last Button -->
                    {% if page_obj.number < page_obj.paginator.num_pages %}
                        <li class="page-item">
                            <a class="page-link text-primary fw-bold px-2 px-md-3" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" title="Last Page">Last &raquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link text-muted px-2 px-md-3">Last &raquo;</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            
            <!-- Jump To Page -->
            <form action="" method="GET" class="d-flex align-items-center m-0">
                {% if search_query %}
                <input type="hidden" name="search" value="{{ search_query }}">
                {% endif %}
                <span class="text-muted small me-2 d-none d-md-block">Go to:</span>
                <div class="input-group input-group-sm" style="width: 90px; border-radius: 8px; overflow: hidden; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);">
                    <input type="number" name="page" class="form-control text-center fw-bold text-primary bg-light border-0" 
                           min="1" max="{{ page_obj.paginator.num_pages }}" placeholder="#" required style="padding-left: 5px; padding-right: 5px;">
                    <button class="btn btn-primary border-0" type="submit" style="padding-left: 6px; padding-right: 6px;">
                        <i class="fas fa-play" style="font-size: 0.6rem;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-800">Bulk Delete Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'bulk_delete_users' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body py-4">
                    <div id="selectionStatus" class="alert alert-info py-2 mb-4 d-none" style="border-radius: 12px; border: none; font-size: 0.8rem;">
                        <i class="fas fa-check-circle me-2"></i> <strong><span id="selectedCount">0</span> users</strong> selected manually.
                        <input type="hidden" name="manual_selection" id="manualSelectionInput" value="">
                    </div>

                    <div id="criteriaSection">
                        <p class="text-muted small mb-4">Or delete users matching specific criteria:</p>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Username Prefix</label>
                            <input type="text" name="prefix" class="form-control" placeholder="e.g. VIP">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Username Exact Length</label>
                            <input type="number" name="user_length" class="form-control" placeholder="e.g. 8">
                        </div>
                    </div>
                    
                    <div class="mb-4 pt-3 border-top">
                        <label class="form-label small fw-bold text-danger">Confirm Super Password</label>
                        <input type="password" name="confirm_password" class="form-control border-danger-subtle" placeholder="Enter super password to confirm" required>
                        <div class="form-text text-danger" style="font-size: 0.7rem;">This action cannot be undone. All WiFi access, profiles, and registration records for matching users will be deleted.</div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light btn-sm fw-bold px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger btn-sm fw-bold px-4" style="background: #f43f5e; border: none;">Delete Now</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Bulk Selection Logic
const selectAll = document.getElementById('selectAll');
const userCheckboxes = document.querySelectorAll('.user-checkbox');
const selectionStatus = document.getElementById('selectionStatus');
const selectedCount = document.getElementById('selectedCount');
const manualSelectionInput = document.getElementById('manualSelectionInput');
const criteriaSection = document.getElementById('criteriaSection');

function updateSelection() {
    const selected = Array.from(userCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    if (selected.length > 0) {
        selectionStatus.classList.remove('d-none');
        selectedCount.textContent = selected.length;
        manualSelectionInput.value = selected.join(',');
        criteriaSection.classList.add('opacity-50');
        // Disable criteria inputs if manual selection is active
        criteriaSection.querySelectorAll('input').forEach(i => i.disabled = true);
    } else {
        selectionStatus.classList.add('d-none');
        manualSelectionInput.value = '';
        criteriaSection.classList.remove('opacity-50');
        criteriaSection.querySelectorAll('input').forEach(i => i.disabled = false);
    }
}

if (selectAll) {
    selectAll.addEventListener('change', () => {
        userCheckboxes.forEach(cb => cb.checked = selectAll.checked);
        updateSelection();
    });
}

userCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateSelection);
});

function autocomplete(inp) {
  var currentFocus;
  inp.addEventListener("input", function(e) {
      var val = this.value;
      closeAllLists();
      if (!val || val.length < 1) { return false; }
      currentFocus = -1;
      
      fetch(`/api/user-autocomplete/?term=${val}`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) return;
            var a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            for (var i = 0; i < data.length; i++) {
                var b = document.createElement("DIV");
                b.innerHTML = "<strong>" + data[i].substr(0, val.length) + "</strong>";
                b.innerHTML += data[i].substr(val.length);
                b.innerHTML += "<input type='hidden' value='" + data[i] + "'>";
                b.addEventListener("click", function(e) {
                    inp.value = this.getElementsByTagName("input")[0].value;
                    closeAllLists();
                    inp.closest('form').submit();
                });
                a.appendChild(b);
            }
        });
  });
  
  inp.addEventListener("keydown", function(e) {
      var x = document.getElementById(this.id + "autocomplete-list");
      if (x) x = x.getElementsByTagName("div");
      if (e.keyCode == 40) {
        currentFocus++;
        addActive(x);
      } else if (e.keyCode == 38) {
        currentFocus--;
        addActive(x);
      } else if (e.keyCode == 13) {
        if (currentFocus > -1) {
          if (x) {
            e.preventDefault();
            x[currentFocus].click();
          }
        }
      }
  });
  
  function addActive(x) {
    if (!x) return false;
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x) {
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }
  function closeAllLists(elmnt) {
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
        x[i].parentNode.removeChild(x[i]);
      }
    }
  }
  document.addEventListener("click", function (e) {
      closeAllLists(e.target);
  });
}

autocomplete(document.getElementById("searchInput"));
</script>
{% endblock %}